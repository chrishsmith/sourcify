generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════════
// AUTHENTICATION MODELS (Better-Auth managed)
// ═══════════════════════════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified Boolean?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // ═══════════════════════════════════════════════════════════════════════════
  // SUBSCRIPTION & BILLING
  // ═══════════════════════════════════════════════════════════════════════════
  tier                  SubscriptionTier @default(free)
  stripeCustomerId      String?          @map("stripe_customer_id")  // Stripe customer ID
  stripeSubscriptionId  String?          @map("stripe_subscription_id")  // Stripe subscription ID
  subscriptionStatus    SubscriptionStatus @default(active) @map("subscription_status")
  subscriptionStart     DateTime?        @map("subscription_start")
  subscriptionEnd       DateTime?        @map("subscription_end")  // For canceled subscriptions
  trialEndsAt           DateTime?        @map("trial_ends_at")  // 14-day trial end date
  
  // ═══════════════════════════════════════════════════════════════════════════
  // USAGE TRACKING (resets daily for free tier)
  // ═══════════════════════════════════════════════════════════════════════════
  classificationsToday  Int       @default(0) @map("classifications_today")
  classificationsReset  DateTime  @default(now()) @map("classifications_reset")  // When counter was last reset
  
  // Core relationships
  sessions        Session[]
  accounts        Account[]
  
  // TradeForge data
  searchHistory   SearchHistory[]
  savedProducts   SavedProduct[]
  tariffAlerts    TariffAlert[]
  savedSuppliers  UserSavedSupplier[]
  usageLogs       UsageLog[]

  @@index([tier])
  @@index([stripeCustomerId])
  @@map("user")
}

enum SubscriptionTier {
  free
  pro
  business
  enterprise
}

enum SubscriptionStatus {
  active
  trialing
  past_due
  canceled
  unpaid
}

model Session {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  userId       String
  accountId    String
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  password     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

// ═══════════════════════════════════════════════════════════════════════════════
// USAGE LOGGING
// Track feature usage for analytics and billing
// ═══════════════════════════════════════════════════════════════════════════════

model UsageLog {
  id          String   @id @default(cuid())
  userId      String
  
  // What feature was used
  feature     UsageFeature
  
  // Additional context
  metadata    Json?    // { htsCode, country, etc. }
  
  // Result tracking
  success     Boolean  @default(true)
  errorCode   String?
  
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, feature, createdAt])
  @@index([feature, createdAt])
  @@map("usage_log")
}

enum UsageFeature {
  classification
  sourcing_analysis
  landed_cost
  supplier_search
  bulk_upload
  api_call
  export_csv
  export_pdf
}

// ═══════════════════════════════════════════════════════════════════════════════
// SEARCH & CLASSIFICATION HISTORY
// Every search a user runs is saved here for future reference
// ═══════════════════════════════════════════════════════════════════════════════

model SearchHistory {
  id              String   @id @default(cuid())
  userId          String?  // Nullable for anonymous searches
  
  // Search Input (what the user entered)
  productName     String?
  productSku      String?
  productDescription String @db.Text
  countryOfOrigin String?
  materialComposition String?
  intendedUse     String?
  
  // Classification Result
  htsCode         String
  htsDescription  String   @db.Text
  confidence      Float
  
  // Full result stored as JSONB (complete ClassificationResult)
  fullResult      Json
  
  // Quick-access fields for filtering/display
  baseDutyRate    String?           // e.g., "5.3%"
  effectiveRate   Float?            // Total with all duties (numeric)
  hasAdditionalDuties Boolean @default(false)
  
  // Status
  status          SearchStatus @default(COMPLETED)
  
  // Metadata
  searchType      SearchType @default(SINGLE)
  batchId         String?           // For bulk imports
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  savedProduct    SavedProduct?     // If user saves this search as a product
  tariffAlerts    TariffAlert[]     // Alerts monitoring this search

  @@index([userId, createdAt(sort: Desc)])
  @@index([htsCode])
  @@index([batchId])
  @@map("search_history")
}

enum SearchStatus {
  COMPLETED
  FAILED
  PENDING
}

enum SearchType {
  SINGLE
  BULK_CSV
  API
}

// ═══════════════════════════════════════════════════════════════════════════════
// SAVED PRODUCTS
// Products the user wants to track long-term (for monitoring, supplier matching)
// ═══════════════════════════════════════════════════════════════════════════════

model SavedProduct {
  id                  String   @id @default(cuid())
  userId              String
  
  // Product Details
  name                String
  description         String   @db.Text
  sku                 String?
  
  // Classification Details (cached from latest search)
  htsCode             String
  htsDescription      String   @db.Text
  countryOfOrigin     String?
  materialComposition String?
  intendedUse         String?
  
  // Cost Summary (for quick display)
  baseDutyRate        String?
  effectiveDutyRate   Float?
  
  // Current Classification Result
  latestClassification Json?
  
  // Flags
  isMonitored         Boolean  @default(false)  // Receive tariff alerts
  isFavorite          Boolean  @default(false)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  user                User @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceSearch        SearchHistory? @relation(fields: [sourceSearchId], references: [id])
  sourceSearchId      String? @unique
  
  tariffAlerts        TariffAlert[]
  costComparisons     CostComparison[]
  supplierMatches     SupplierMatch[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([htsCode])
  @@map("saved_product")
}

// ═══════════════════════════════════════════════════════════════════════════════
// TARIFF MONITORING & ALERTS
// Track tariff changes and notify users
// ═══════════════════════════════════════════════════════════════════════════════

model TariffAlert {
  id              String   @id @default(cuid())
  userId          String
  
  // What we're monitoring
  htsCode         String
  countryOfOrigin String?
  
  // Rate at time of creation (to detect changes)
  originalRate    Float
  currentRate     Float?
  
  // Alert settings
  alertType       AlertType @default(ANY_CHANGE)
  threshold       Float?    // For THRESHOLD type: alert if change > X%
  
  // Status
  isActive        Boolean   @default(true)
  lastChecked     DateTime?
  lastAlertSent   DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  savedProduct    SavedProduct? @relation(fields: [savedProductId], references: [id])
  savedProductId  String?
  searchHistory   SearchHistory? @relation(fields: [searchHistoryId], references: [id])
  searchHistoryId String?
  
  alertEvents     TariffAlertEvent[]

  @@index([htsCode, countryOfOrigin])
  @@index([userId, isActive])
  @@map("tariff_alert")
}

enum AlertType {
  ANY_CHANGE
  INCREASE_ONLY
  DECREASE_ONLY
  THRESHOLD
}

model TariffAlertEvent {
  id            String   @id @default(cuid())
  alertId       String
  
  previousRate  Float
  newRate       Float
  changePercent Float
  changeType    String   // "increase" | "decrease"
  
  // What changed (Section 301, IEEPA, etc.)
  changeReason  String?
  details       Json?
  
  // Notification status
  notifiedAt    DateTime?
  notifyMethod  String?   // "email" | "webhook" | "in_app"
  
  createdAt     DateTime @default(now())
  
  alert         TariffAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@index([alertId, createdAt(sort: Desc)])
  @@map("tariff_alert_event")
}

// ═══════════════════════════════════════════════════════════════════════════════
// SUPPLIER DATABASE
// Curated, verified suppliers from around the world
// ═══════════════════════════════════════════════════════════════════════════════

model Supplier {
  id                  String   @id @default(cuid())
  
  // Basic Info
  name                String
  slug                String   @unique  // URL-friendly name
  description         String?  @db.Text
  website             String?
  email               String?
  phone               String?
  
  // Location
  countryCode         String   // ISO 2-letter code (CN, VN, MX, etc.)
  countryName         String
  region              String?  // e.g., "Guangdong", "Ho Chi Minh"
  city                String?
  address             String?
  
  // Capabilities (what they can make)
  productCategories   String[] // e.g., ["Electronics", "Textiles", "Plastics"]
  htsChapters         String[] // HTS chapters they specialize in: ["84", "85", "39"]
  materials           String[] // e.g., ["Cotton", "Polyester", "Aluminum"]
  
  // Business Details
  employeeCount       EmployeeRange?
  yearEstablished     Int?
  annualRevenue       RevenueRange?
  exportPercentage    Int?     // % of production exported
  
  // Certifications & Trust
  certifications      String[] // e.g., ["ISO 9001", "BSCI", "SA8000"]
  isVerified          Boolean  @default(false)
  verificationDate    DateTime?
  verificationNotes   String?
  
  // Quality Indicators
  reliabilityScore    Float?   // 0-100
  qualityScore        Float?   // 0-100
  communicationScore  Float?   // 0-100
  overallScore        Float?   // Weighted average
  
  // Cost Indicators (relative, not absolute)
  costTier            CostTier? // LOW, MEDIUM, HIGH
  minOrderValue       Float?    // USD
  typicalLeadDays     Int?
  
  // Sourcing
  tier                SupplierTier @default(UNVERIFIED)
  
  // Data sourcing metadata
  dataSource          String?   // Where we found this supplier
  lastScrapedAt       DateTime? // Last time we updated from external source
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  savedByUsers        UserSavedSupplier[]
  productMatches      SupplierMatch[]
  costData            SupplierCostData[]
  verification        SupplierVerification?
  htsSpecializations  SupplierHtsSpecialization[]

  @@index([countryCode])
  @@index([htsChapters])
  @@index([overallScore(sort: Desc)])
  @@map("supplier")
}

enum EmployeeRange {
  SMALL       // 1-50
  MEDIUM      // 51-200
  LARGE       // 201-1000
  ENTERPRISE  // 1000+
}

enum RevenueRange {
  UNDER_1M
  ONE_TO_10M
  TEN_TO_50M
  FIFTY_TO_100M
  OVER_100M
}

enum CostTier {
  LOW
  MEDIUM
  HIGH
}

enum SupplierTier {
  UNVERIFIED
  BASIC       // Basic verification done
  VERIFIED    // Full verification
  PREMIUM     // Premium partner
}

model UserSavedSupplier {
  id          String   @id @default(cuid())
  userId      String
  supplierId  String
  
  notes       String?  @db.Text
  tags        String[]
  isFavorite  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([userId, supplierId])
  @@map("user_saved_supplier")
}

// ═══════════════════════════════════════════════════════════════════════════════
// COUNTRY MANUFACTURING COST DATA
// Powers the interactive global map - cost comparison by country
// ═══════════════════════════════════════════════════════════════════════════════

model CountryManufacturingCost {
  id              String   @id @default(cuid())
  
  // Country
  countryCode     String   // ISO 2-letter
  countryName     String
  
  // HTS Chapter (costs vary by product type)
  htsChapter      String?  // Null = general country average
  productCategory String?  // e.g., "Electronics", "Textiles"
  
  // Cost Factors (indexed relative to China = 100)
  laborCostIndex      Float    // Manufacturing labor cost
  overheadCostIndex   Float?   // Factory overhead, utilities
  materialCostIndex   Float?   // Raw material availability
  
  // Shipping to USA
  shippingCostIndex   Float?   // Relative shipping cost
  typicalTransitDays  Int?
  
  // Trade & Tariffs
  baseTariffRate      Float?   // MFN rate for this category
  additionalDuties    Float?   // Section 301, IEEPA, etc.
  effectiveTariffRate Float?   // Total tariff burden
  hasFTA              Boolean  @default(false)
  ftaName             String?  // e.g., "USMCA", "Korea FTA"
  
  // Risk & Reliability
  politicalRiskScore  Float?   // 0-100 (100 = low risk)
  supplyChainRisk     Float?   // 0-100
  qualityReputation   Float?   // 0-100
  
  // Overall Score (for ranking)
  overallCostScore    Float?   // Weighted composite
  
  // Metadata
  dataSource          String?
  lastUpdated         DateTime @default(now())
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([countryCode, htsChapter])
  @@index([htsChapter, overallCostScore])
  @@map("country_manufacturing_cost")
}

// ═══════════════════════════════════════════════════════════════════════════════
// SUPPLIER MATCHING & COST COMPARISON
// Links products to potential suppliers with cost estimates
// ═══════════════════════════════════════════════════════════════════════════════

model SupplierMatch {
  id              String   @id @default(cuid())
  
  savedProductId  String
  supplierId      String
  
  // Match Quality
  matchScore      Float    // 0-100 how well supplier fits product
  matchReasons    String[] // Why this supplier matches
  
  // Estimated Costs
  estimatedUnitCost     Float?
  estimatedDutyRate     Float?
  estimatedShippingCost Float?
  estimatedTotalCost    Float?
  estimatedSavings      Float?  // vs current country
  
  createdAt       DateTime @default(now())
  
  savedProduct    SavedProduct @relation(fields: [savedProductId], references: [id], onDelete: Cascade)
  supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([savedProductId, supplierId])
  @@index([matchScore(sort: Desc)])
  @@map("supplier_match")
}

model CostComparison {
  id              String   @id @default(cuid())
  
  savedProductId  String
  
  // Country being compared
  countryCode     String
  countryName     String
  
  // Cost Breakdown
  estimatedLaborCost    Float?
  estimatedMaterialCost Float?
  estimatedShippingCost Float?
  estimatedDutyRate     Float?
  estimatedTotalCost    Float?
  
  // Comparison to current
  savingsVsCurrent      Float?   // Positive = cheaper
  savingsPercent        Float?
  
  // Factors considered
  assumptions     Json?
  
  createdAt       DateTime @default(now())
  
  savedProduct    SavedProduct @relation(fields: [savedProductId], references: [id], onDelete: Cascade)

  @@unique([savedProductId, countryCode])
  @@index([savingsPercent(sort: Desc)])
  @@map("cost_comparison")
}

// ═══════════════════════════════════════════════════════════════════════════════
// SUPPLIER COST DATA (Per-Supplier, Per-Product Category)
// More granular than country-level data
// ═══════════════════════════════════════════════════════════════════════════════

model SupplierCostData {
  id              String   @id @default(cuid())
  
  supplierId      String
  
  // Product Category
  htsChapter      String?
  productCategory String
  
  // Costs
  minUnitCost     Float?
  maxUnitCost     Float?
  typicalUnitCost Float?
  currency        String   @default("USD")
  
  // MOQ & Lead Time
  minOrderQty     Int?
  minOrderValue   Float?
  typicalLeadDays Int?
  
  // Validity
  quotedAt        DateTime?
  validUntil      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId, productCategory])
  @@map("supplier_cost_data")
}

// ═══════════════════════════════════════════════════════════════════════════════
// BULK IMPORT BATCHES
// Track CSV/bulk imports
// ═══════════════════════════════════════════════════════════════════════════════

model BulkImportBatch {
  id              String   @id @default(cuid())
  userId          String
  
  // File info
  fileName        String
  fileUrl         String?
  
  // Status
  status          BatchStatus @default(PENDING)
  totalRows       Int
  processedRows   Int      @default(0)
  successCount    Int      @default(0)
  errorCount      Int      @default(0)
  
  // Errors
  errors          Json?    // Array of { row, error }
  
  // Timing
  startedAt       DateTime?
  completedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, createdAt(sort: Desc)])
  @@map("bulk_import_batch")
}

enum BatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ═══════════════════════════════════════════════════════════════════════════════
// SHIPMENT RECORDS (BOL DATA)
// Raw import/shipment records from Bill of Lading data
// Used to derive HTS costs by country and verify suppliers
// ═══════════════════════════════════════════════════════════════════════════════

model ShipmentRecord {
  id                  String    @id @default(cuid())
  
  // Shipment identification
  billOfLading        String?
  masterBol           String?
  
  // Parties - Foreign supplier
  shipperName         String
  shipperCountry      String    // ISO 2-letter code
  shipperAddress      String?
  
  // Parties - US importer
  consigneeName       String
  consigneeAddress    String?
  
  // Product details
  htsCode             String    // 6 or 10 digit HTS code
  productDescription  String?   @db.Text
  quantity            Float?
  quantityUnit        String?   // "PCS", "KG", "DOZ", "LB", etc.
  declaredValue       Float?    // USD
  weight              Float?
  weightUnit          String?   // "KG", "LB"
  
  // Logistics
  portOfLading        String?   // Origin port
  portOfUnlading      String?   // US destination port
  carrier             String?   // Shipping carrier
  vesselName          String?
  arrivalDate         DateTime?
  
  // Metadata
  dataSource          String    // "cbp", "importgenius", "panjiva", etc.
  sourceRecordId      String?   // Original record ID from source
  scrapedAt           DateTime  @default(now())
  
  // Computed fields
  unitValue           Float?    // declaredValue / quantity
  
  createdAt           DateTime  @default(now())

  @@unique([dataSource, sourceRecordId])
  @@index([htsCode, shipperCountry])
  @@index([shipperName])
  @@index([consigneeName])
  @@index([arrivalDate])
  @@index([htsCode])
  @@map("shipment_record")
}

// ═══════════════════════════════════════════════════════════════════════════════
// HTS COST BY COUNTRY
// Aggregated cost data derived from ShipmentRecords
// THE KEY TABLE for "what does HTS X cost from country Y"
// ═══════════════════════════════════════════════════════════════════════════════

model HtsCostByCountry {
  id                  String    @id @default(cuid())
  
  // HTS + Country identifier
  htsCode             String    // 6-digit (subheading) or 10-digit
  countryCode         String    // ISO 2-letter code
  countryName         String
  
  // Derived from aggregating shipment records
  avgUnitValue        Float     // Average $/unit from BOL data
  medianUnitValue     Float?    // Median (outlier-resistant)
  minUnitValue        Float?
  maxUnitValue        Float?
  stdDeviation        Float?    // For confidence calculation
  
  // Volume metrics
  shipmentCount       Int       // Number of shipments aggregated
  totalQuantity       Float     // Total units across all shipments
  totalValue          Float     // Total USD value
  
  // Time range of data
  oldestShipment      DateTime?
  newestShipment      DateTime?
  
  // Tariff data (enriched from USITC)
  baseTariffRate      Float?    // MFN rate for this HTS
  section301Rate      Float?    // Section 301 rate if applicable
  ieepaRate           Float?    // IEEPA reciprocal rate if applicable
  adCvdRate           Float?    // Anti-dumping/countervailing duties
  effectiveTariff     Float?    // Total tariff from this country
  hasFTA              Boolean   @default(false)
  ftaRate             Float?    // Preferential rate under FTA
  ftaName             String?   // e.g., "USMCA", "KORUS"
  
  // Confidence scoring (0-100)
  confidenceScore     Float     // Based on data volume + recency
  
  lastCalculated      DateTime  @default(now())
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([htsCode, countryCode])
  @@index([htsCode])
  @@index([countryCode])
  @@index([confidenceScore(sort: Desc)])
  @@map("hts_cost_by_country")
}

// ═══════════════════════════════════════════════════════════════════════════════
// SUPPLIER VERIFICATION
// Track verification status, sources, and confidence scores for suppliers
// ═══════════════════════════════════════════════════════════════════════════════

model SupplierVerification {
  id                      String    @id @default(cuid())
  supplierId              String    @unique
  
  // Verification sources - where was this supplier found?
  foundInBol              Boolean   @default(false)
  bolShipmentCount        Int       @default(0)
  bolFirstSeen            DateTime?
  bolLastSeen             DateTime?
  
  foundInDirectory        Boolean   @default(false)
  directorySource         String?   // "thomasnet", "kompass", etc.
  directoryUrl            String?
  
  foundInTradeShow        Boolean   @default(false)
  tradeShowName           String?
  tradeShowYear           Int?
  
  foundInCertDb           Boolean   @default(false)
  certificationSource     String?   // "iso", "bsci", etc.
  
  // Website verification
  websiteVerified         Boolean   @default(false)
  websiteDomainAge        Int?      // Years
  hasValidSsl             Boolean?
  hasContactInfo          Boolean?
  
  // Certification verification
  certificationsVerified  String[]  // List of verified certifications
  
  // Overall verification score (0-100)
  verificationScore       Float
  verificationDate        DateTime?
  verificationNotes       String?   @db.Text
  
  // Relation
  supplier                Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@map("supplier_verification")
}

// ═══════════════════════════════════════════════════════════════════════════════
// SUPPLIER HTS SPECIALIZATION
// Links suppliers to specific HTS codes they ship with volume data
// Derived from analyzing ShipmentRecords
// ═══════════════════════════════════════════════════════════════════════════════

model SupplierHtsSpecialization {
  id                  String    @id @default(cuid())
  supplierId          String
  
  // HTS code (can be 2-digit chapter, 4-digit heading, or full 10-digit)
  htsCode             String
  htsDescription      String?
  
  // Volume data from shipments
  shipmentCount       Int       // How many times they shipped this HTS
  totalQuantity       Float?    // Total units shipped
  totalValue          Float?    // Total USD shipped
  avgUnitValue        Float?    // Their average price for this HTS
  
  // Time data
  firstShipment       DateTime?
  lastShipment        DateTime?
  
  // Relation
  supplier            Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([supplierId, htsCode])
  @@index([htsCode])
  @@index([supplierId])
  @@map("supplier_hts_specialization")
}

// ═══════════════════════════════════════════════════════════════════════════════
// COUNTRY TARIFF REGISTRY
// Single source of truth for all tariff data by country
// All services (classification, sourcing, alerts) consume this data
// ═══════════════════════════════════════════════════════════════════════════════

model CountryTariffProfile {
  id                  String    @id @default(cuid())
  
  // Country identification
  countryCode         String    @unique  // ISO 3166-1 alpha-2 (e.g., 'SG', 'CN')
  countryName         String
  region              String?             // 'Asia', 'Europe', 'Americas', etc.
  flag                String?             // Emoji flag
  
  // Trade status
  tradeStatus         TradeStatus @default(normal)
  
  // FTA information
  hasFta              Boolean   @default(false)
  ftaName             String?             // 'USMCA', 'Singapore FTA', etc.
  ftaWaivesBaseDuty   Boolean   @default(false)
  ftaWaivesIeepa      Boolean   @default(false)  // Only USMCA currently
  ftaNotes            String?   @db.Text
  
  // IEEPA baseline (April 2025+)
  // Universal 10% applies to nearly ALL countries including FTA partners!
  ieepaBaselineRate   Float     @default(10)     // 10% minimum for most countries
  ieepaExempt         Boolean   @default(false)  // True only for USMCA compliant goods
  
  // Fentanyl tariffs (CN, MX, CA)
  fentanylRate        Float?              // 20% for CN, 25% for MX/CA
  fentanylActive      Boolean   @default(false)
  
  // Country-specific reciprocal rate (if higher than baseline)
  // Vietnam: 46%, Cambodia: 49%, Thailand: 36%, etc.
  reciprocalRate      Float?
  
  // Section 301 (China only)
  section301Active    Boolean   @default(false)
  section301DefaultRate Float?            // Default rate for Chapter 99
  
  // Pre-computed totals (for quick queries)
  // This is the SUM of all additional duties (not including base MFN)
  totalAdditionalRate Float     @default(0)
  
  // Metadata
  lastVerified        DateTime  @default(now())
  lastUpdated         DateTime  @updatedAt
  sources             String[]  @default([])  // Legal references
  notes               String?   @db.Text
  
  // Relations
  programs            TariffProgram[]
  htsOverrides        HtsTariffOverride[]
  
  createdAt           DateTime  @default(now())

  @@index([tradeStatus])
  @@index([hasFta])
  @@map("country_tariff_profile")
}

enum TradeStatus {
  normal      // Standard MFN treatment
  fta         // Free Trade Agreement partner
  elevated    // Higher than normal tariffs (China, Vietnam, etc.)
  sanctioned  // Trade restrictions apply
}

model TariffProgram {
  id                  String    @id @default(cuid())
  
  // Program identification
  programId           String              // 'section301_list3', 'ieepa_fentanyl_cn'
  programName         String              // 'Section 301 List 3'
  programType         ProgramType
  
  // Rate information
  rate                Float               // Percentage (e.g., 25.0)
  rateType            RateType  @default(ad_valorem)
  specificAmount      Float?              // For specific duties ($/unit)
  specificUnit        String?             // 'kg', 'unit', etc.
  
  // Status
  active              Boolean   @default(true)
  effectiveDate       DateTime
  expirationDate      DateTime?
  
  // Legal basis
  htsChapter99Code    String?             // '9903.88.03'
  authority           String              // 'USTR', 'President', 'Commerce'
  legalReference      String              // 'Trade Act of 1974, Section 301'
  executiveOrder      String?             // 'EO 14257'
  federalRegister     String?             // '90 FR 12345'
  
  // Scope
  appliesToAllHts     Boolean   @default(true)
  description         String?   @db.Text
  
  // Relation
  countryProfileId    String
  countryProfile      CountryTariffProfile @relation(fields: [countryProfileId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([countryProfileId, programId])
  @@index([programType])
  @@index([active])
  @@map("tariff_program")
}

enum ProgramType {
  section_301       // China trade tariffs
  ieepa_fentanyl    // Fentanyl emergency (CN, MX, CA)
  ieepa_reciprocal  // Reciprocal/baseline tariffs
  ieepa_baseline    // Universal 10% baseline (April 2025+)
  section_232       // Steel/Aluminum/Auto
  adcvd             // Antidumping/Countervailing duties
  gsp               // Generalized System of Preferences
  other
}

enum RateType {
  ad_valorem        // Percentage of value
  specific          // Fixed amount per unit
  compound          // Both ad valorem and specific
}

model HtsTariffOverride {
  id                  String    @id @default(cuid())
  
  // HTS targeting
  htsCode             String              // Full or partial (e.g., '8518.30', '85')
  htsDescription      String?   @db.Text
  matchType           HtsMatchType @default(prefix)  // 'exact', 'prefix', 'chapter'
  
  // Override details
  overrideType        ProgramType
  rate                Float
  rateType            RateType  @default(ad_valorem)
  
  // Status
  active              Boolean   @default(true)
  effectiveDate       DateTime
  expirationDate      DateTime?
  
  // Legal reference
  listName            String?             // 'List 3', 'List 4A'
  legalReference      String?
  federalRegister     String?
  
  // Relation
  countryProfileId    String
  countryProfile      CountryTariffProfile @relation(fields: [countryProfileId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([htsCode])
  @@index([countryProfileId, htsCode])
  @@index([active])
  @@map("hts_tariff_override")
}

enum HtsMatchType {
  exact             // Must match exactly
  prefix            // Matches HTS codes starting with this
  chapter           // Matches entire chapter
}

// ═══════════════════════════════════════════════════════════════════════════════
// HTS CODE DATABASE
// Complete US Harmonized Tariff Schedule stored locally for fast queries
// Source: USITC Official Excel Publication (https://hts.usitc.gov/)
// ═══════════════════════════════════════════════════════════════════════════════

model HtsCode {
  id              String   @id @default(cuid())
  
  // Code structure
  code            String   @unique  // "6109100012" (10 digits max, no dots)
  codeFormatted   String             // "6109.10.00.12" (with dots for display)
  level           HtsLevel           // chapter, heading, subheading, tariff_line, statistical
  
  // Hierarchy relationships
  parentCode      String?            // "61091000" for "6109100012"
  chapter         String             // "61" (first 2 digits)
  heading         String?            // "6109" (first 4 digits)
  subheading      String?            // "610910" (first 6 digits)
  
  // Description
  description     String   @db.Text
  indent          Int      @default(0)  // Indentation level in HTS (0-5)
  
  // Duty rates (as strings from HTS - can be complex)
  generalRate     String?            // "16.5%" or "Free" or "2.4¢/kg + 5.6%"
  specialRates    String?  @db.Text  // "Free (AU, BH, CL, CO, IL, JO, KR...)"
  column2Rate     String?            // Rate for non-NTR countries
  units           String?            // "doz" or "kg" or "No." or "doz/kg"
  
  // Parsed rates for calculations
  adValoremRate   Float?             // 16.5 (just the percentage part)
  specificRate    Float?             // 2.4 (cents/amount per unit)
  specificUnit    String?            // "kg", "doz", "No.", etc.
  
  // AI-extracted metadata (populated on import)
  keywords        String[]           // ["cotton", "t-shirt", "knit", "apparel"]
  productCategory String?            // "apparel", "electronics", "kitchenware"
  
  // Parent indent groupings (captured from HTS Excel structure)
  // e.g., ["Men's or boys'", "T-shirts"] or ["Kitchen and table implements"]
  parentGroupings String[]           // Indent text that applies to this code
  
  // Effective dates
  effectiveDate   DateTime?
  expirationDate  DateTime?
  
  // Sync metadata
  lastSynced      DateTime @default(now())
  sourceRevision  String?            // "2025 HTSA Rev 1"
  
  // Semantic search (pgvector - managed via raw SQL, not Prisma)
  // embedding       vector(1536)     -- Added via migration
  // embeddingContext String?         -- The text used to generate the embedding
  // embeddingGeneratedAt DateTime?   -- When embedding was generated
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([chapter])
  @@index([heading])
  @@index([subheading])
  @@index([parentCode])
  @@index([level])
  @@index([keywords], type: Gin)
  // @@index([embedding], type: Hnsw)  -- Added via migration (pgvector HNSW index)
  @@map("hts_code")
}

enum HtsLevel {
  chapter         // 2-digit: "61"
  heading         // 4-digit: "6109"
  subheading      // 6-digit: "610910"
  tariff_line     // 8-digit: "61091000"
  statistical     // 10-digit: "6109100012"
}

// HTS Schedule Revision Tracking
// Tracks what version of the HTS we have vs what's available
model HtsRevision {
  id              String   @id @default(cuid())
  
  // Revision identification
  revisionId      String   @unique  // "2025-basic-rev1" or "2025.1"
  year            Int                // 2025
  revisionNumber  Int      @default(1)  // 1, 2, 3 for mid-year revisions
  
  // Source info
  sourceUrl       String?            // USITC download URL
  publishedDate   DateTime?          // When USITC published this revision
  effectiveDate   DateTime?          // When it takes legal effect
  
  // Our sync status
  status          RevisionStatus @default(available)
  syncedAt        DateTime?          // When we imported this revision
  totalCodes      Int?               // How many codes in this revision
  
  // Notes
  changesSummary  String?  @db.Text  // What changed from previous revision
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([year, revisionNumber])
  @@index([status])
  @@map("hts_revision")
}

enum RevisionStatus {
  available       // We know about it, haven't synced
  syncing         // Currently importing
  current         // This is what we have loaded
  superseded      // We've moved to a newer revision
}

// Metadata for HTS sync operations
model HtsSyncLog {
  id              String   @id @default(cuid())
  
  // Sync details
  sourceFile      String             // "hts_2025_rev1.xlsx"
  sourceRevision  String             // "2025 HTSA Rev 1"
  sourceUrl       String?            // Where we downloaded from
  revisionId      String?            // Link to HtsRevision
  
  // Results
  status          SyncStatus
  totalRecords    Int       @default(0)
  recordsCreated  Int       @default(0)
  recordsUpdated  Int       @default(0)
  recordsExpired  Int       @default(0)
  errors          Json?              // Array of parsing errors
  
  // Timing
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  durationMs      Int?
  
  createdAt       DateTime  @default(now())

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([revisionId])
  @@map("hts_sync_log")
}

enum SyncStatus {
  pending
  running
  completed
  failed
}
